<%- include('../includes/usersPartials/userHead.ejs') %>
<style>
  .price-tag {
    color: rgb(255, 45, 45);
  }
  .container-main {
    margin-top: 6%;
  }
  .form-control:focus {
    box-shadow: none;
  }
  .form-input {
    border: none;
    border-radius: 0;
    border-bottom: 2px solid #b04fff7c;
  }
  .form-input-home {
    width: 100%;
  }
  .container-form {
    display: none;
    transition: all 0.3s ease;
  }
  .p-div {
    line-height: 40px;
  }
</style>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Available Coupons</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
              <%if(coupons){%>
                <%coupons.forEach((item)=>{%>
                  <div class="border-bottom p-2 d-flex">
                    <p style="text-transform: uppercase;cursor: pointer;color: #b04fff;" class="coupon-code-available me-2"><%=item.code%></p>
                    <span style="text-transform: capitalize;color: #c60000;">(<%=item.value%>% Discount) Select to add Coupon</span>
                 </div>
                 <%})%>
              <%}%>
       </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<div class="container container-main">
  <h4 class="mb-2">Billing Details</h4>
  <div class="row">
    <div class="col-md-7 mb-5">
      <div class="mt-2 border rounded border-2 shadow p-3">
        <h4>
          Delivery Address
          <small class="text-warning" style="font-size: xx-small"
            >(Address that set as primary)</small
          >
        </h4>
        <%if(addressPrimary){%>
        <div class="ms-1 p-div mt-3">
          <p>
            Name : <%=addressPrimary.firstname%> <%=addressPrimary.lastname%>
          </p>
          <p>Street Address : <%=addressPrimary.address%></p>
          <p>
            State,District : <%=addressPrimary.state%>,
            <%=addressPrimary.district%>
          </p>
          <p>
            City,Locality : <%=addressPrimary.city%>,
            <%=addressPrimary.locality%>
          </p>
          <p>PostalCode : <%=addressPrimary.postalcode%></p>
          <p>Phone : <%=addressPrimary.phone%></p>
        </div>
        <%}%>
        <div class="d-flex justify-content-end">
          <button
            style="background-color: #b04fff; color: #ffffff"
            class="btn form-btn"
          >
            Add Address
          </button>
        </div>
      </div>
      <div class="container p-5 border rounded container-form mt-1 shadow">
        <div><h4>Add Delivery Address</h4></div>
        <form id="form" data-userid="<%=user._id%>">
          <div class="row">
            <div class="col-md-6 col-sm-6 mt-3">
              <div>
                <strong><label for="">Firstname</label></strong>
                <input
                  id="firstname"
                  type="text"
                  name="firstname"
                  class="form-control p-3 mt-1 form-input"
                  placeholder="Enter the firstname"
                />
                <p style="font-size: smaller" class="mt-2 text-danger warn"></p>
              </div>
            </div>
            <div class="col-md-6 col-sm-6 mt-3">
              <div>
                <strong><label for="">Lastname</label></strong>

                <input
                  id="lastname"
                  type="text"
                  name="lastname"
                  class="form-control p-3 mt-1 form-input"
                  placeholder="Enter the lastname"
                />
                <p style="font-size: smaller" class="mt-2 text-danger warn"></p>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mt-3">
              <div>
                <strong><label for="">Street Address</label></strong>

                <input
                  id="address"
                  type="text"
                  name="address"
                  class="form-control p-3 mt-1 form-input"
                  placeholder="Street/Home Address"
                />
                <p style="font-size: smaller" class="mt-2 text-danger warn"></p>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 col-sm-6 mt-3">
              <div>
                <strong><label for="">State</label></strong>

                <input
                  id="state"
                  type="text"
                  name="state"
                  class="form-control p-3 mt-1 form-input"
                  placeholder="State"
                />
                <p style="font-size: smaller" class="mt-2 text-danger warn"></p>
              </div>
            </div>
            <div class="col-md-6 col-sm-6 mt-3">
              <div>
                <strong><label for="">District</label></strong>
                <input
                  id="district"
                  type="text"
                  name="district"
                  class="form-control p-3 mt-1 form-input"
                  placeholder="Enter your District Name"
                />
                <p style="font-size: smaller" class="mt-2 text-danger warn"></p>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 col-sm-6 mt-3">
              <div>
                <strong><label for="">City</label></strong>
                <input
                  id="city"
                  type="text"
                  name="city"
                  class="form-control p-3 mt-1 form-input"
                  placeholder="Enter your city"
                />
                <p style="font-size: smaller" class="mt-2 text-danger warn"></p>
              </div>
            </div>
            <div class="col-md-6 col-sm-6 mt-3">
              <div>
                <strong><label for="">Locality</label></strong>

                <input
                  id="locality"
                  type="text"
                  name="locality"
                  class="form-control p-3 mt-1 form-input"
                  placeholder="Enter your locality"
                />
                <p style="font-size: smaller" class="mt-2 text-danger warn"></p>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 col-sm-6 mt-3">
              <div>
                <strong><label for="">Post</label></strong>
                <input
                  id="postalCode"
                  type="text"
                  name="postalCode"
                  class="form-control p-3 mt-1 form-input"
                  placeholder="Enter your Postal Code"
                />
                <p style="font-size: smaller" class="mt-2 text-danger warn"></p>
              </div>
            </div>
            <div class="col-md-6 col-sm-6 mt-3">
              <div>
                <strong><label for="">Phone No</label></strong>
                <input
                  id="phone"
                  type="text"
                  name="phone"
                  class="form-control p-3 mt-1 form-input"
                  placeholder="Enter your Phone Number"
                />
                <p style="font-size: smaller" class="mt-2 text-danger warn"></p>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-end">
            <button
              type="submit"
              style="color: #ffffff; background-color: #b04fff"
              class="btn px-4 py-1 mt-4"
            >
              Add Address
            </button>
          </div>
        </form>
      </div>

      <div class="mt-4 border rounded border-2 shadow p-3">
        <h4>Add Payment Details</h4>
        <div style="display: inline-flex; align-items: baseline" class="mt-3">
          <input id="cashOnDelivery" type="radio" name="paymentMethod" class="mt-1 me-2 payment-method" value="cod" />
          <label for="cashOnDelivery"><strong>Cash On Delivery</strong></label>
        </div>
        <div  class="mt-3 d-flex align-items-baseline">
          <input id="razorpay-input" type="radio" name="paymentMethod" class=" me-2 mb-2 payment-method" value="razorpay"/>
          <img width="90px" src="/imagesLocal/razorpay.png" alt="">
        </div>
      </div>
      <div class="mt-4 border rounded border-2 shadow p-3">
        <div class="d-flex justify-content-between">
          <h4>
            <i style="color: #b04fff;" class="fa-solid fa-wallet me-2"></i>
            Wallet</h4>
            <p class="me-3">
              Bal : â‚¹
              <% if(wallet){%>
              <span class="balance-wallet">
              <%=wallet.balance%>
            </span>
            <% }else{%>
            <span class="balance-wallet">
              0
            </span>
            <%}%>
            <span style="font-size: small;" class="text-warning">(You can Only Use 80%) *</span>
            </p>
        </div>
        
        <div style="display: inline-flex; align-items: baseline" class="mt-3">
          <input id="wallet-check" type="checkbox" name="" class="mt-1 me-2 " value="wallet" />
          <label for="wallet"><strong>Use Wallet</strong></label>
        </div>
      </div>
    </div>

    <!--column-->
    <div class="col-md-5">
      <div class="border shadow rounded p-4">
        <div class="d-flex justify-content-between">
          <h4>Add Coupon</h4>
          <%if(coupons.length > 0){%>
            <div data-bs-toggle="modal" data-bs-target="#exampleModal">
              <p style="color: #c60000;cursor: pointer;">Coupons Available</p>
            </div>
          <%}%>
        </div>
        <div class="mt-3">
            <label for="">Coupon Code</label>
            <input name="coupon" type="text" class="form-control coupon-code"/>
            <p class="text-danger"></p>
            <button
              id="coupon-btn"
              type="submit"
              style="color: #ffffff; background-color: #b04fff"
              class="btn px-4 py-1 mt-3"
            >
              Add Coupon
            </button>
         
        </div>
      </div>
      <div class="border rounded p-4 mt-3 shadow mb-5">
        <%if(cartProducts){%> <% cartProducts.forEach((item)=>{%>

        <div
          class="d-flex justify-content-between mb-3 align-items-center border-bottom"
        >
          <div class="d-block">
            <div class="py-2 d-flex align-items-center">
              <img
                style="max-width: 40px"
                src="/productImg/<%=item.productDetails.image[0]%>"
                alt=""
              />
              <p class="ms-3">Qty : <%=item.products.quantity%></p>
            </div>
          </div>
          <div>
            <p>Size : <%=item.products.size%></p>
          </div>
          <div>
            <p style="text-transform: capitalize">
              <%=item.productDetails.productName%>
            </p>
          </div>
          <div>
            <p class="price-tag">â‚¹<%=item.totalPrice%></p>
          </div>
        </div>
        <% })%> <%}else if(productInfo){%>
        <div
          class="d-flex justify-content-between mb-3 align-items-center border-bottom"
        >
          <div class="d-block">
            <div class="py-2 d-flex align-items-center">
              <img
                style="max-width: 40px"
                src="/productImg/<%=productInfo[0].image[0]%>"
                alt=""
              />
              <p class="ms-3">Qty : 1</p>
            </div>
          </div>
          <div>
            <p>Size : <%=productInfo[0].sizes%></p>
          </div>
          <div>
            <p style="text-transform: capitalize">
              <%=productInfo[0].productName%>
            </p>
          </div>
          <div>
            <p class="price-tag">â‚¹<%=productInfo[0].productPrice%></p>
          </div>
        </div>
        <%}%>
        <!-- <div class="d-flex justify-content-between mb-3 align-items-center border-bottom ">
              <div class="d-block">
                  <div class="py-2">
                      <img style="max-width: 40px;" src="/productImg/1709564003145back2.jpg" alt="">
                  </div>
              </div>
              
              <div>
                  <p>product name </p>
              </div>
              <div>
                  <p>â‚¹price</p>
              </div>
          </div> -->

        <h4>Order Summary</h4>
        <div class="border-bottom p-div mt-3">
          <%if(grandTotal){%>
          <div class="d-flex justify-content-between">
            <p>Subtotal</p>
            <span class="price-tag">â‚¹<%=grandTotal%></span>
          </div>
          <%}else if(productInfo){%>
          <div class="d-flex justify-content-between">
            <p>Subtotal</p>
            <span class="price-tag">â‚¹<%=productInfo[0].productPrice%></span>
          </div>
          <%}%>
          <div class="d-flex justify-content-between">
            <p>Wallet</p>
            <span class="wallet-tag text-danger">â‚¹-/</span>
          </div>
          <div class="d-flex justify-content-between">
            <p>Coupon</p>
            <span class="coupon-tag text-danger">â‚¹-/</span>
          </div>
        </div>
        <div class="mt-2 d-flex justify-content-between">
          <strong>Grand Total</strong>
          <%if(grandTotal){%>
          <strong class="total-price-cart text-danger">â‚¹<%=grandTotal%></strong>
          <%}else if(productInfo){%>
          <strong class="total-price-single text-danger">â‚¹<%=productInfo[0].productPrice%></strong>
          <%}%>
        </div>
        <small class="text-warning">(Inclusive of all taxes)</small>
        <div class="d-flex justify-content-center mt-3">
          <form id="placeOrder-form" action="" method="post">
            <div data-userid="<%=user._id%>" class="form-content-div">
              <%if(productInfo){%>
              <input
              
              class="form-product-id"
                name="productName"
                value="<%=productInfo[0]._id%>"
                type="text"
                hidden
              />
              <input
              class="form-product-size"
                name="size"
                value="<%=productInfo[0].sizes%>"
                type="text"
                hidden
              />
              <input
              class="form-product-price"
                name="price"
                value="<%=productInfo[0].productPrice%>"
                type="text"
                hidden
              />
              <%}%>
            </div>
            <button
            
              type="submit"
              style="color: white; background-color: #b04fff"
              class="btn px-5 cod-btn"
            >
              Place Order
            </button>
            <button
          
          type="button"
          id="rzp-btn"
          style="color: white; background-color: #b04fff;display: none;"
          class="btn px-5 razorpay-btn"
          data-grandtotal="<%= grandTotal ?  grandTotal : false %>"
          data-singleproduct="<%=productInfo ? productInfo[0].productPrice : false%>"

        >
          Pay Now
        </button>
          </form>
        </div>
        <div class="mt-3">
          <strong class="text-danger">
            <%=error%>
          </strong>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module" src="/scripts/shopScripts/checkoutPage.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  const couponCode = document.querySelectorAll('.coupon-code-available');
  if(couponCode){
    const inputCoupon = document.querySelector('.coupon-code')
    couponCode.forEach((item)=>{
    item.addEventListener('click',()=>{
      inputCoupon.value = item.innerText;
    })
  })
  }
  
  const placeOrderForm = document.getElementById("placeOrder-form");
  const radioCashonDelivery = document.getElementById("cashOnDelivery");
  const razorpayInput = document.getElementById('razorpay-input');
  const userId = "<%=user._id%>";
  
  placeOrderForm.addEventListener("submit", (e) => {
  let walletAmount = document.querySelector('.wallet-tag').innerText;
   walletAmount = walletAmount.slice(1);
   if(walletAmount === '-/'){
    walletAmount = false
   }
   couponTag = document.querySelector('.coupon-tag').innerText;
   couponTag = couponTag.slice(1);
   if(couponTag === '-/'){
    couponTag = false
   }
   console.log(couponTag)
   console.log(walletAmount)


  // alert(walletAmount);
    if (!radioCashonDelivery.checked && !razorpayInput.checked) {
      e.preventDefault();
      Swal.fire("Chose Payment method");
    } else {
      placeOrderForm.setAttribute(
        "action",
        `/placeOrder/${userId}?walletAmount=${walletAmount}&couponDiscount=${couponTag}`
      );
      placeOrderForm.submit();
    }
  });

  
 const inputs = document.querySelectorAll(".payment-method");
 const codBtn = document.querySelector('.cod-btn');
 const razorpayBtn = document.querySelector('.razorpay-btn');
 inputs.forEach((item)=>{
  item.addEventListener('click',()=>{
    if(item.checked){
      if(item.value === 'cod'){
        razorpayBtn.style.display = 'none';
        codBtn.style.display = 'block';
      }else{
        razorpayBtn.style.display = 'block';
        codBtn.style.display = 'none';
      }
    }
  })
 });



 



</script>
<script src="/scripts/validation/checkoutPageV.js"></script>
<%- include('../includes/usersPartials/userEnd.ejs') %>
