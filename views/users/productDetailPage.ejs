<%-include('../includes/usersPartials/userHead')%>
<div style="margin-top: 120px;" class="container">
Home/Product Details 
</div>
 <div style="margin-top: 30px;" class="container border p-3 mb-5">
  <div class="row">
    <div class="col-12 col-md-6">
      <div style="width: fit-content;" id="carouselExampleControlsNoTouching" class="carousel slide" data-bs-touch="false" data-bs-interval="false">
        <div style="max-height:600px;" class="carousel-inner">
          <div class="carousel-item active">
            <img  src="/productImg/<%=product.image[0]%>" class="d-block w-100" alt="...">
          </div>
          <div class="carousel-item">
            <img  src="/productImg/<%=product.image[1]%>" class="d-block w-100" alt="...">
          </div>
          <div class="carousel-item">
            <img  src="/productImg/<%=product.image[2]%>" class="d-block w-100" alt="...">
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControlsNoTouching" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControlsNoTouching" data-bs-slide="next">
          <span  class="carousel-control-next-icon carousel-control-next-icon-dark" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
    
    </div>
    <div class="col-12  col-md-6">
      <div class="d-flex justify-content-end ">
        <div class="p-3">
          <%if(user){%>
          <i style="font-size: larger;font-weight: 900;cursor: pointer;" class="fa-regular fa-heart heart-wishlist" data-productid="<%= product._id %>"
          data-userid="<%=user._id%>"> Add to wishlist</i>
           <% }%>
        </div>
      </div>
      <div class="me-5">
      <div class=" p-5 me-2">
        
        <h2 style="text-transform: capitalize;"><%= product.productName %></h2>
        <%if(product.offer.actualAmount){%>
        <h4 class="mt-3 ">Price : <s style="font-size: medium;" class="">₹<%=product.offer.actualAmount%></s>
          <span style="font-size: medium;color: #b04fff;" ><%=product.offer.offerValue%>% OFF</span>
          <span class="text-success ms-2">₹<%= product.productPrice%></span>
        </h4>
        <%}else{%>
          <h4 class="mt-3 ">Price : <span class="text-danger">₹<%= product.productPrice %></span></h4>
        <%}%>
        <div class="mt-4">
          <h4>Details</h4>
          <p class="mt-3"><%= product.description %></p>
        </div>
        
        <hr class="mt-4">
        <div class="p-2">
          <h5>Available Sizes</h5>
          <form id="form" action="" method="post">
          <div class="d-flex  mt-4">
           <% product.sizes.forEach((size)=>{ %> 
           <% if(size === 'S'){ %>
            <div>
              <input value="S" type="radio" class="btn-check " name="size" id="sizeS" autocomplete="off">
              <label for="sizeS" class="btn btn-outline-dark ms-1 px-3">S</label>
            </div>
            <% }else if(size === 'M'){ %>
            <div class="ms-3">
              <input value="M" type="radio" class="btn-check"  name="size" id="sizeM" autocomplete="off">
              <label for="sizeM" class="btn btn-outline-dark ms-1 px-3">M</label>
            </div>
            <% }else if(size === 'L'){ %>
            <div class="ms-3">
              <input value="L" type="radio" class="btn-check" name="size" id="sizeL" autocomplete="off">
              <label for="sizeL" class="btn btn-outline-dark ms-1 px-3">L</label>
            </div>
            <% }else if(size === 'XL'){ %>
            <div class="ms-3">
              <input value="XL" type="radio" class="btn-check" name="size" id="sizeXL" autocomplete="off">
              <label for="sizeXL" class="btn btn-outline-dark ms-1 px-3">XL</label>
            </div>
            <% }else if(size === 'XXL'){ %>
            <div class="ms-3">
              <input value="XXL" type="radio" class="btn-check" name="size" id="sizeXXL" autocomplete="off">
              <label for="sizeXXL" class="btn btn-outline-dark ms-1 px-3">XXL</label>
            </div>
            <%}%>
            <%})%>
          </div>
          </div>
          <%if(!error){%>
            <div class="mt-5 d-flex justify-content-between">
              <button id="cart-btn" style="background-color: rgba(111, 1, 255, 0.795);border: none;width: 45%;" type="button" class="btn btn-primary ">
                 Add to Cart 
                <i class="fa-solid fa-cart-shopping mt-1 ms-2"></i></button>          
              </form>
              <a id="buy-link" style="color: black;" href="#">
                <div>
              <button id="buy-btn" style="background-color: rgba(255, 255, 255, 0.795);border:1px solid black;color: black;" type="button" class="btn  px-5">
                BUY NOW
              </button> 
            </div> 
            </a>        
          </div>
         
        
          
         
        <% }else{ %>
          <div class="mt-5 d-flex justify-content-between">
            <button id="cart-btn" style="background-color: rgba(111, 1, 255, 0.795);border: none;width: 45%;" type="submit" class="btn btn-primary " disabled>
               Add to Cart 
              <i class="fa-solid fa-cart-shopping mt-1 ms-2"></i></button>          
            </form>
            <a id="buy-link" style="color: black;" href="#">
              <div>
            <button id="buy-btn" style="background-color: rgba(255, 255, 255, 0.795);border:1px solid black;color: black;" type="button" class="btn  px-5" disabled>
              BUY NOW
            </button> 
          </div> 
          </a>        
        </div>
        <div class="mt-3 text-danger">
          <h4>Out Of Stock !</h4>
        </div>
          <%}%>
        </div>
      </div>
      </div>
    </div>
    </div>
  </div>
  <hr class="mt-5">
  
  <div class="d-flex justify-content-around">
    <h3>You may Also Like</h3>
  </div>
  <div class="container">
    <div class="row mt-5">
      <% allProducts.forEach((item)=>{ %>
        <div class="col-sm-6 col-md-4 col-lg-3 p-b-35 isotope-item women">
          <!-- Block2 -->
          <div class="block2">
            <div style="max-height: 350px;" class="block2-pic hov-img0">
              <a href="/productDetail/<%= item._id %>">
              <img src="/productImg/<%= item.image[0]%>" alt="IMG-PRODUCT">
            </a>
            </div>
  
            <div class="block2-txt flex-w flex-t p-t-14">
              <div class="block2-txt-child1 flex-col-l ">
                <a  class="stext-104 cl4 hov-cl1 trans-04 js-name-b2 p-b-6">
                  <%= item.productName %>
                </a>
                
                  <%if(item.offer.actualAmount){%>
                    <div>
                    <s class="stext-105 cl3 ">
                      ₹<%= item.offer.actualAmount%>
                    </s>
                    <span style="font-size: medium;color: #b04fff;" class=" ms-2"><%=item.offer.offerValue%>% OFF</span>
                    <div>
                      <span style="font-size: medium;" class="stext-105 cl3 text-success">
                        ₹<%= item.productPrice%>
                      </span>
                    </div>
                   
                  </div>
                    <%}else{%>
                      <span class="stext-105 cl3">
                        ₹<%= item.productPrice%>
                      </span>
                   <% }%>
              </div>
              <div style="cursor: pointer;" class="block2-txt-child2 flex-r p-t-3 heart-wishlist" data-userid="<%=user._id%>" data-productid="<%=item._id%>">
                <!-- <a href="#" class="btn-addwish-b2 dis-block pos-relative  "> -->
                  <img class="icon-heart1 dis-block trans-04 wishlist-icon" src="/images/icons/icon-heart-01.png" alt="ICON">
                  <!-- <img class="icon-heart2 dis-block trans-04 ab-t-l" src="/images/icons/icon-heart-02.png" alt="ICON"> -->
                <!-- </a> -->
              </div>
            </div>
          </div>
        </div>
        <%});%>
    </div>
    <div class="d-flex justify-content-center p-4 mb-5">
      <a href="/shopPage">
        <button class="btn bg-black text-white px-5 circle">Load More</button>
      </a>
    </div>
  </div>
</div>



<!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->
<script>
const cartBtn = document.getElementById('cart-btn');
cartBtn.addEventListener('click',()=>{

const size = document.getElementsByName('size');
let selectedSize ;
size.forEach((item)=>{
  if(item.checked){
    selectedSize =  item.value
  }
 
})
if (!selectedSize) {
    Swal.fire("Please Select a Size!");
    return;
  }
console.log(selectedSize);
const userId = '<%= user._id %>'; 
const productId = '<%= product._id %>';
addToCartFromDetail(selectedSize,userId,productId)



})


async function addToCartFromDetail(size,userId,productId){
try{
  const response = await fetch(`/addToCart/${productId}?userId=${userId}`,{
    method:'POST',
    headers :{
      'content-type' : 'application/json'
    },
    body : JSON.stringify({

      size

    })
    
  });
  const data = await response.json();
  const result = data.message

  console.log(result);


if(result === 'success'){
 await Swal.fire({
  position: "center",
  icon: "success",
  title: "Item Added to the Cart",
  showConfirmButton: false,
  timer: 1500
});

}else{
  Swal.fire("No More Product Available");
}



  if (!response.ok) {
      console.log('failed fetch');
    }
}catch(error){
console.log(error);
}

}


const buyNowLink = document.getElementById('buy-link');
  const buyButton = document.getElementById('buy-btn');

  // Add click event listener to the button
  buyButton.addEventListener('click', function() {
    // Set the href attribute of the anchor element
    const sizeRadioButtons = document.getElementsByName('size');
    let selectedSize;
  for (let i = 0; i < sizeRadioButtons.length; i++) {
    if (sizeRadioButtons[i].checked) {
      selectedSize = sizeRadioButtons[i].value;
      break;
    }
  }
  if (!selectedSize) {
    Swal.fire("Please Select a Size!");
    return;
  }else{
    const productId = "<%=product._id%>"; // Replace with actual product ID
    console.log(productId);
      buyNowLink.setAttribute('href', `/checkoutDirect/${productId}?size=${selectedSize}`);
    }
  });

  
  const wishlistBtn = document.querySelectorAll('.heart-wishlist');

wishlistBtn.forEach((item)=>{
const productId = item.dataset.productid ;
const userId = item.dataset.userid ;

item.addEventListener('click',async()=>{
//   console.log(userId);
// console.log(productId);
  const response = await fetch(`/addToWishlist/${productId}`,{
    method : "POST",
    headers:{
      'content-type' : 'application/json'
    },
    body : JSON.stringify({
      userId
    })
  })
  const result = await response.json();
  console.log(result);
  if(!response.ok){
    // const icon = item.querySelector('.wishlist-icon');
    // icon.setAttribute('src','/images/icons/icon-heart-02.png');
    console.log('failed to do task');
  }
  if(result === 'success'){
  await Swal.fire({
  position: "center",
  icon: "success",
  title: "Added to wishlist",
  showConfirmButton: false,
  timer: 1500
});
  }else if(result === 'error'){
    Swal.fire('Product Already Exists')
  }
})
})

 
</script>
<%- include('../includes/usersPartials/userEnd.ejs') %>